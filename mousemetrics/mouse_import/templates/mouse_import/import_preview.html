{% extends "base.html" %}
{% block title %}Import Preview{% endblock %}
{% load dict_extras %}
{% block content %}

  <h1>Preview Import to {{ import_obj.project.name }}</h1>

  {% if messages %}
    <ul>
      {% for m in messages %}
        <li>{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <p>
    <strong>File:</strong> {{ import_obj.original_filename }} |
    <strong>Sheet:</strong>
    {{ import_obj.sheet_name|default_if_none:"(active)"|default:"(active)" }} |
    <strong>Range:</strong>
    {{ import_obj.cell_range|default_if_none:"(entire sheet)"|default:"(entire sheet)" }} |
    <strong>Rows:</strong> {{ import_obj.row_count }}
  </p>

  <h3 class="text-xl font-medium text-gray-900">Column Mapping</h3>

  <div class="flex-container flex gap-4">
    <div class="form-section flex-1">
      <form method="post">
        {% csrf_token %}
        {% for field in form %}
          <div class="relative flex items-center">
            <label for="{{ field.id_for_label }}" class="w-32 flex-class-0">{{ field.label }}</label>
            <div class="bg-amber-400 my-1">{{ field }}</div>
          </div>
        {% endfor %}

        <button type="submit" class="btn-primary">Save Mapping</button>
      </form>
    </div>

    {% if saved_mapping %}
      <div class="saved-mapping-section flex-1">
        <h3>Saved mapping</h3>
        <table class="mx-2">
          <thead>
            <tr class="table-header">
              <th class="table-header-text">Source column</th>
              <th class="table-header-text">Target field</th>
            </tr>
          </thead>
          <tbody>
            {% for src, dst in saved_mapping.items %}
              <tr class="table-data border-2 border-black">
                <td class="table-padding">{{ src }}</td>
                <td class="table-padding">{{ dst }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  {% if saved_mapping %}
    <form method="post" action="{% url 'mouse_import:import_commit' import_obj.id %}">
      {% csrf_token %}
      <button type="submit">Commit Import</button>
    </form>
  {% else %}
    <p><em>Save a mapping first to enable commit.</em></p>
  {% endif %}

  <table class="mx-2">
    <caption class="py-2 text-start text-sm">
      Data Preview (first 50 rows)
    </caption>
    <thead>
      <tr class="table-header">
        {% for c in columns %}
          <th class="table-header-text">{{ c }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
        <tr class="table-data">
          {% for c in columns %}
            <td class="table-padding">{{ row|get_item:c }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

{% endblock %}
