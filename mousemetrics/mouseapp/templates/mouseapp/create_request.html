{% extends "base.html" %}

{% block title %}Create {{ request_type }} Request{% endblock %}

{% block content %}
  <div class="max-w-2xl mx-auto mt-6">
    <div class="card p-6">
      <h1 class="page-title">Create {{ request_type|lower }} request</h1>

      <form method="post">
        {% csrf_token %}
        {{ form.kind }}

        {% if form.errors %}
          <div class="error-message">
            <h3 class="text-red-800 font-semibold mb-2">Please correct the following errors:</h3>
            {% if form.non_field_errors %}
              <ul class="list-disc list-inside text-red-700 mb-2">
                {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% endif %}
            {% for field in form %}
              {% if field.errors %}
                <p class="text-red-700"><strong>{{ field.label }}:</strong>
                  {% for error in field.errors %}
                    {{ error }}
                  {% endfor %}
                </p>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

        <div class="space-y-4">
          <div>
            <label for="{{ form.project.id_for_label }}" class="block text-sm font-medium text-neutral-800 mb-1">
              {{ form.project.label }}
            </label>
            {{ form.project }}
            {% if form.project.errors %}
              <p class="mt-1 error-message-compact">{{ form.project.errors }}</p>
            {% endif %}
            {% if form.project.help_text %}
              <p class="mt-1 text-sm text-neutral-700 font-medium">{{ form.project.help_text }}</p>
            {% endif %}
          </div>

          <div>
            <label for="{{ form.mouse.id_for_label }}" class="block text-sm font-medium text-neutral-800 mb-1">
              {{ form.mouse.label }}
            </label>
            {{ form.mouse }}
            {% if form.mouse.errors %}
              <p class="mt-1 error-message-compact">{{ form.mouse.errors }}</p>
            {% endif %}
            {% if form.mouse.help_text %}
              <p class="mt-1 text-sm text-neutral-700 font-medium">{{ form.mouse.help_text }}</p>
            {% endif %}
          </div>

          <div>
            <label for="{{ form.details.id_for_label }}" class="block text-sm font-medium text-neutral-800 mb-1">
              {{ form.details.label }}
            </label>
            {{ form.details }}
            {% if form.details.errors %}
              <p class="mt-1 error-message-compact">{{ form.details.errors }}</p>
            {% endif %}
            {% if form.details.help_text %}
              <p class="mt-1 text-sm text-neutral-700 font-medium">{{ form.details.help_text }}</p>
            {% endif %}
          </div>
        </div>

        <div class="mt-6 flex gap-3">
          <button type="submit" class="btn-primary">Create Request</button>
          {% if mouse_id %}
            <a href="{% url 'mouseapp:mouse' mouse_id %}" class="btn-secondary">Cancel</a>
          {% else %}
            <a href="{% url 'mouseapp:requests' %}" class="btn-secondary">Cancel</a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const projectSelect = document.getElementById('id_project');
      const mouseSelect = document.getElementById('id_mouse');

      if (projectSelect && mouseSelect) {
        // Store the initially selected mouse value
        const initialMouseValue = mouseSelect.value;

        // Load mice if a project is pre-selected
        const initialProjectId = projectSelect.value;
        if (initialProjectId) {
          loadMiceForProject(initialProjectId, initialMouseValue);
        }

        projectSelect.addEventListener('change', function() {
          const projectId = this.value;
          if (projectId) {
            loadMiceForProject(projectId);
          } else {
            mouseSelect.innerHTML = '<option value="">---------</option>';
          }
        });
      }

      function loadMiceForProject(projectId, preserveMouseValue = null) {
        fetch(`{% url 'mouseapp:get_mice_for_project' %}?project=${projectId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to load mice');
            }
            return response.json();
          })
          .then(data => {
            mouseSelect.innerHTML = '<option value="">---------</option>';
            if (data.mice && data.mice.length > 0) {
              data.mice.forEach(mouse => {
                const option = document.createElement('option');
                option.value = mouse.id;
                option.textContent = mouse.display;
                // Preserve the initially selected mouse if it matches
                if (preserveMouseValue && mouse.id == preserveMouseValue) {
                  option.selected = true;
                }
                mouseSelect.appendChild(option);
              });
            } else {
              const option = document.createElement('option');
              option.value = '';
              option.textContent = 'No mice available in this project';
              option.disabled = true;
              mouseSelect.appendChild(option);
            }
          })
          .catch(error => {
            console.error('Error loading mice:', error);
            mouseSelect.innerHTML = '<option value="">Error loading mice</option>';
          });
      }
    });
  </script>
{% endblock %}
